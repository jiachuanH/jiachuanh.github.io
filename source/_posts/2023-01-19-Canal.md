---
title: Canal
date: 2023-01-19 20:09:19
tags:
 - å¤§æ•°æ®
---



# ä¸€ã€æ¦‚è¿°



## ç®€ä»‹

â€‹      é˜¿é‡Œå·´å·´ B2B å…¬å¸ï¼Œå› ä¸ºä¸šåŠ¡çš„ç‰¹æ€§ï¼Œå–å®¶ä¸»è¦é›†ä¸­åœ¨å›½å†…ï¼Œä¹°å®¶ä¸»è¦é›†ä¸­åœ¨å›½å¤–ï¼Œæ‰€ ä»¥è¡ç”Ÿå‡ºäº†==åŒæ­¥æ­å·å’Œç¾å›½å¼‚åœ°æœºæˆ¿çš„éœ€æ±‚ï¼Œ==ä» 2010 å¹´å¼€å§‹ï¼Œé˜¿é‡Œç³»å…¬å¸å¼€å§‹é€æ­¥çš„å°è¯• åŸºäºæ•°æ®åº“çš„æ—¥å¿—è§£æï¼Œè·å–å¢é‡å˜æ›´è¿›è¡ŒåŒæ­¥ï¼Œç”±æ­¤è¡ç”Ÿå‡ºäº†å¢é‡è®¢é˜…&æ¶ˆè´¹çš„ä¸šåŠ¡ã€‚ Canal æ˜¯ç”¨ Java å¼€å‘çš„åŸºäºæ•°æ®åº“å¢é‡æ—¥å¿—è§£æï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜…&æ¶ˆè´¹çš„ä¸­é—´ä»¶ã€‚ ç›®å‰ã€‚==Canal ä¸»è¦æ”¯æŒäº† MySQL çš„ Binlog è§£æï¼Œè§£æå®Œæˆåæ‰åˆ©ç”¨ Canal Client æ¥å¤„ç†è·å¾— çš„ç›¸å…³æ•°æ®ã€‚==ï¼ˆæ•°æ®åº“åŒæ­¥éœ€è¦é˜¿é‡Œçš„ Otter ä¸­é—´ä»¶ï¼ŒåŸºäº Canalï¼‰ã€‚



## å·¥ä½œåŸç†

- **åˆ©ç”¨Mysqlä¸»ä»å¤åˆ¶ [^è§Maxwell]**



æŠŠè‡ªå·±ä¼ªè£…æˆ Slaveï¼Œå‡è£…ä» Master å¤åˆ¶æ•°æ®ã€‚







## ä½¿ç”¨åœºæ™¯



> é˜¿é‡Œ Otter ä¸­é—´ä»¶çš„ä¸€éƒ¨åˆ†



![image-20220419175308400](../image/image-20220419175308400.png)





- åœºæ™¯1 ï¼šæ›´æ–°ç¼“å­˜

  ![image-20220419175420214](../image/image-20220419175420214.png)





- åœºæ™¯2   

  æŠ“å–ä¸šåŠ¡è¡¨çš„æ–°å¢å˜åŒ–æ•°æ®ï¼Œç”¨äºåˆ¶ä½œå®æ—¶ç»Ÿè®¡ï¼ˆæˆ‘ä»¬å°±æ˜¯è¿™ç§åœºæ™¯ï¼‰





# äºŒã€å®‰è£…éƒ¨ç½²



## å‡†å¤‡å·¥ä½œ

```sh
#åˆ›å»ºæ•°æ®åº“gamll-2021

#åˆ›å»ºæ•°æ®è¡¨
CREATE TABLE user_info(
`id` VARCHAR(255),
`name` VARCHAR(255),
`sex` VARCHAR(255)
);


```



**ğŸš©Mysqlçš„Binlogé…ç½®ä¸æµ‹è¯• è§Maxwell**



```sql
#èµ‹æƒ
mysql>GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'canal'@'%' IDENTIFIED BY 'canal' ;
```



## ä¸‹è½½å®‰è£…

[ä¸‹è½½é“¾æ¥](https://github.com/alibaba/canal/releases)        ==canal.deployer-1.1.2.tar.gz==

```sh
#ä¸‹è½½åä¸Šä¼ åˆ°/opt/sortware  è§£å‹åˆ° /opt/module/canal
ğŸš©æå‰åˆ›å»º/opt/module/canal
$ tar -zxvf canal.deployer-1.1.2.tar.gz -C /opt/module/canal
```





## ä¿®æ”¹é…ç½®



- **canal.properties**

  ```sh
  #åœ¨/opt/module/canal/conf
  
  ğŸ‘‡ä¿®æ”¹å¦‚ä¸‹å†…å®¹
  #################################################
  ######### common argument ############# 
  #################################################
  
  # tcp, kafka, RocketMQ
  canal.serverMode = tcp
  
  #################################################
  ######### destinations ############# 
  #################################################
  canal.destinations = example
  
  ```

  

`canal.destinations = example`



==ä¸€ä¸ª canal æœåŠ¡ ä¸­å¯ä»¥æœ‰å¤šä¸ª instanceï¼Œconf/ä¸‹çš„æ¯ä¸€ä¸ª exampleæ–‡ä»¶ å³æ˜¯ä¸€ä¸ªå®ä¾‹é»˜è®¤ä¸€ä¸ª==



<!--å¦‚æœéœ€è¦å¤šä¸ªå®ä¾‹å¤„ç†ä¸åŒçš„ MySQL æ•°æ®çš„è¯ï¼Œç›´ æ¥æ‹·è´å‡ºå¤šä¸ª exampleï¼Œå¹¶å¯¹å…¶é‡æ–°å‘½åï¼Œå‘½åå’Œé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„åç§°ä¸€è‡´ï¼Œç„¶åä¿®æ”¹ canal.properties ä¸­çš„ canal.destinations=å®ä¾‹ 1ï¼Œå®ä¾‹ 2ï¼Œå®ä¾‹ 3ã€‚-->





- **instance.properties**

  ```sh
  #åœ°å€/opt/module/canal/conf/example
  
  #é…ç½®MysqlæœåŠ¡å™¨åœ°å€
  
  #################################################
  ## mysql serverId , v1.0.26+ will autoGen 
  canal.instance.mysql.slaveId=20
  
  canal.instance.master.address=hadoop102:3306
  
  
  
  #é…ç½®è¿æ¥ MySQL çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œé»˜è®¤å°±æ˜¯æˆ‘ä»¬å‰é¢æˆæƒçš„ canal
  # username/password
  canal.instance.dbUsername=canal
  canal.instance.dbPassword=canal
  ```

  



# ä¸‰ã€æ¡ˆä¾‹å®æ“



`å®æ—¶ç›‘æ§`

## TCP æ¨¡å¼æµ‹è¯•



- **åœ¨ideaåˆ›å»º gmall-canal é¡¹ç›®**

- **é…ç½®pom**

  ```properties
      <dependencies>
          <dependency>
              <groupId>com.alibaba.otter</groupId>
              <artifactId>canal.client</artifactId>
              <version>1.1.2</version>
          </dependency>
          <dependency>
              <groupId>org.apache.kafka</groupId>
              <artifactId>kafka-clients</artifactId>
              <version>2.4.1</version>
          </dependency>
      </dependencies>
  ```

- **åˆ›å»º com.atguigu.app åŒ…åˆ›å»º CanalClient**

  ```java
  public class CanalClient {
      public static void main(String[] args) throws InterruptedException, InvalidProtocolBufferException {
  
  
          //1 è·å–canalè¿æ¥å¯¹è±¡
          CanalConnector connector = CanalConnectors.newSingleConnector(
                  new InetSocketAddress("hadoop102", 11111), "example", "", "");
  
  
          while (true) {
              //2 è·å–è¿æ¥
              connector.connect();
  
              //3 è®¢é˜…æ•°æ®åº“
              connector.subscribe("gmall-2021.*");
  
              //4 è·å–æ•°æ®
              Message message = connector.get(100);
  
              //5 è·å–Entryé›†åˆ
              List<CanalEntry.Entry> entries = message.getEntries();
  
              //6 åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®
              if (entries.size() <= 0) {
                  System.out.println("æ²¡æœ‰æ•°æ®");
                  Thread.sleep(1000);
  
  
              } else {
                  //7 è§£æEntry
                  for (CanalEntry.Entry entry : entries) {
                      //7.1 è·å–è¡¨å
                      String tableName = entry.getHeader().getTableName();
  
                      //7.2 è·å–entryç±»å‹
  
                      CanalEntry.EntryType entryType = entry.getEntryType();
  
                      //7.3 è·å–åºåˆ—åŒ–åæ•°æ®
                      ByteString storeValue = entry.getStoreValue();
  
                      //7.4 åˆ¤æ–­å½“å‰entryTypeæ˜¯å¦æ˜¯ROWDATA
                      if (CanalEntry.EntryType.ROWDATA.equals(entryType)) {
  
                          //7.4.1 ååºåˆ—åŒ–è·å–rowData
                          CanalEntry.RowChange rowChange = CanalEntry.RowChange.parseFrom(storeValue);
  
                          //7.4.2 è·å–äº‹ä»¶çš„æ“ä½œç±»å‹
                          CanalEntry.EventType eventType = rowChange.getEventType();
  
                          //7.4.3 è·å–æ•°æ®é›†
                          List<CanalEntry.RowData> rowDatas = rowChange.getRowDatasList();
  
                          //7.4.4 éå†æ•°æ®é›†ï¼Œæ‰“å°æ•°æ®
                          for (CanalEntry.RowData rowData : rowDatas) {
  
                              // æ›´æ–°å‰çš„æ•°æ®
                              JSONObject beforeData = new JSONObject();
                              //éå†æ›´æ–°å‰çš„æ•°æ®
                              rowData.getBeforeColumnsList().forEach(beforeColumn -> {
                                  beforeData.put(beforeColumn.getName(), beforeColumn.getValue());
                              });
  
  
                              // æ›´æ–°åçš„æ•°æ®
                              JSONObject afterData = new JSONObject();
                              //éå†æ›´æ–°åçš„æ•°æ®
                              rowData.getAfterColumnsList().forEach(afterColumn -> {
                                  afterData.put(afterColumn.getName(), afterColumn.getValue());
                              });
  
                              //æ‰“å°æ•°æ®
                              System.out.println("tableName:" + tableName + " eventType:" + eventType + " beforeData:" + beforeData + " afterData:" + afterData);
                          }
  
  
                      } else {
                          System.out.println("å½“å‰entryTypeæ˜¯" + entryType);
                      }
  
  
                  }
  
              }
  
  
          }
  
  
      }
  }
  
  
  
  ```

  



#### Canalæ•°æ®ç»“æ„



![image-20220419182943835](../image/image-20220419182943835.png)





- å¯åŠ¨canal

  ```sh
  canal]$ bin/startup.sh
  ```

- è¿è¡Œä»£ç 

- å‘æ•°æ®åº“gmall-2021/user_infoåšå¢åˆ æ”¹æ“ä½œ

- æŸ¥çœ‹ideaçš„æ§åˆ¶å°





## Kafka æ¨¡å¼



- ä¿®æ”¹canal.properties        tcpï¼Œæ”¹ä¸ºè¾“å‡ºåˆ° kafka

  ```properties
  #################################################
  ######### common argument ############# 
  #################################################
  canal.id = 1
  canal.ip =
  canal.port = 11111
  canal.metrics.pull.port = 11112
  canal.zkServers =
  # flush data to zk
  canal.zookeeper.flush.period = 1000
  canal.withoutNetty = false
  # tcp, kafka, RocketMQ
  canal.serverMode = kafka
  					ğŸ‘†
  # flush meta cursor/parse position to file
  
  ```

- ä¿®æ”¹ Kafka é›†ç¾¤çš„åœ°å€

  ```properties
  ##################################################
  ######### MQ #############
  ##################################################
  canal.mq.servers = hadoop102:9092,hadoop103:9092,hadoop104:9092
  ```

- ä¿®æ”¹ instance.properties è¾“å‡ºåˆ° Kafka çš„ä¸»é¢˜ä»¥åŠåˆ†åŒºæ•°

  ```properties
  # mq config
  canal.mq.topic=canal_test
  canal.mq.partitionsNum=1
  # hash partition config
  #canal.mq.partition=0
  #canal.mq.partitionHash=mytest.person:id,mytest.role:id
  ```

  

<!--æ³¨æ„ï¼šé»˜è®¤è¿˜æ˜¯è¾“å‡ºåˆ°æŒ‡å®š Kafka ä¸»é¢˜çš„ä¸€ä¸ª kafka åˆ†åŒºï¼Œå› ä¸ºå¤šä¸ªåˆ†åŒºå¹¶è¡Œå¯èƒ½ä¼šæ‰“ ä¹± binlog çš„é¡ºåº ï¼Œ å¦‚ æœ è¦ æ é«˜ å¹¶ è¡Œ åº¦ ï¼Œ é¦– å…ˆ è®¾ ç½® kafka çš„ åˆ† åŒº æ•° >1, ç„¶ å è®¾ ç½® canal.mq.partitionHash å±æ€§-->



#### æµ‹è¯•

- å¯åŠ¨canal

  ```sh
  canal]$ bin/startup.sh
  ```

- å¯åŠ¨ Kafka æ¶ˆè´¹å®¢æˆ·ç«¯

  ```sh
  bin/kafka-console-consumer.sh --bootstrap-server hadoop102:9092 --topic canal_test
  ```

- å‘æ•°æ®åº“gmall-2021/user_infoåšå¢åˆ æ”¹æ“ä½œ

- æŸ¥çœ‹kafkaæ¶ˆè´¹è€…çš„æ§åˆ¶å°













